{% extends 'base.html' %}
{% load static %}
{% block content %}

    <link rel="stylesheet" href="{% static 'admin/style.css' %}">
    <div class="admin-admin-wrapper">

        {% with 'users' as active_page %}
            {% include 'admin/admin_sidebar.html' %}
        {% endwith %}

        <main class="admin-main-content">

            <div class="admin-content-header">
                <h1>Users Management {% if not user.is_superuser %}
                    <span style="color: #dc3545;">No Permission</span>{% endif %}</h1>

                <button class="admin-btn admin-btn-primary" id="add_tag">Add New Tag</button>

            </div>

            <div class="admin-search-container">
                <input type="text" placeholder="Search by title, author, etc.">
                <button class="admin-btn admin-btn-primary">Search</button>
            </div>

            <div class="admin-book-list">

                <div class="admin-user-list-header">
                    <div>

                        <a href="{% url 'admin_tag' %}?sort={% if sort_by == 'id' %}-{% endif %}id">
                            ID

                            {% if sort_by == 'id' or sort_by == '' %}
                                <span class="sort-icon">▲</span> {% elif sort_by == '-id' %}
                                <span class="sort-icon">▼</span> {% endif %}
                        </a>

                    </div>
                    <div>Name</div>
                    <div>Email</div>
                    <div>Active</div>
                    <div>Staff</div>
                    <div>Superuser</div>
                    <div class="admin-actions">Actions</div>
                </div>


                {% for user in page_obj %}


                    <div class="admin-user-list-item">
                        <div data-label="id">{{ user.id }}</div>
                        <div><span data-label="fname">{{ user.first_name }}</span> <span
                                data-label="lname">{{ user.last_name }}</span></div>
                        <input type="hidden" value="{{ user.last_login }}" data-label="lastlogin">
                        <div data-label="email">{{ user.email }}</div>
                        <div data-label="">
                            {% if user.is_active %}
                                ✅ 活跃
                            {% else %}
                                ❌ 禁用
                            {% endif %}
                        </div>
                        <div data-label="staff">
                            <input type="hidden" value="{{ user.is_staff }}">
                            {% if user.is_staff %}
                                ✅
                            {% else %}
                                ❌
                            {% endif %}
                        </div>
                        <div data-label="superuser">
                            <input type="hidden" value="{{ user.is_superuser }}">
                            {% if user.is_superuser %}
                                ✅
                            {% else %}
                                ❌
                            {% endif %}
                        </div>
                        <div class="admin-actions">
                            <form method="post" action="{% url 'admin_user_active' %}" style="display:inline;">
                                {% csrf_token %}
                                <input type="hidden" value="{{ user.id }}" name="id">
                                <button class="admin-btn admin-btn-active" type="submit"
                                        onclick="return confirm('Confirm this action. This action cannot be undone!');">
                                    {% if user.is_active %}Deactivate{% else %}Activate{% endif %}
                                </button>
                            </form>
                            <a class="admin-btn admin-btn-edit">Edit</a>
                            <form method="POST"
                                  action=""
                                  style="display: inline;">

                                {% csrf_token %}
                                <input type="hidden" name="id" value="">
                                <button type="submit"
                                        class="admin-btn admin-btn-danger"

                                        onclick="return confirm('Are you sure you want to delete the User {{ book.title }}? This action cannot be undone!');">

                                    Delete

                                </button>


                            </form>
                        </div>
                    </div>
                {% empty %}
                    <p>No content.</p>

                {% endfor %}


                <nav class="admin-pagination">

                    {% if page_obj.has_previous %}
                        <a href="?sort={{ sort_by }}&page={{ page_obj.previous_page_number }}">Previous</a>
                    {% else %}
                        <a href="#" class="admin-disabled" onclick="return false;">Previous</a>
                    {% endif %}

                    {% for i in page_obj.paginator.get_elided_page_range %}

                        {% if i == page_obj.paginator.ELLIPSIS %}
                            <span>...</span>

                        {% elif i == page_obj.number %}
                            <a href="#" class="admin-active">{{ i }}</a>

                        {% else %}
                            <a href="?sort={{ sort_by }}&page={{ i }}">{{ i }}</a>

                        {% endif %}

                    {% endfor %}

                    {% if page_obj.has_next %}
                        <a href="?sort={{ sort_by }}&page={{ page_obj.next_page_number }}">Next</a>
                    {% else %}
                        <a href="#" class="admin-disabled" onclick="return false;">Next</a>
                    {% endif %}
                </nav>
            </div>
        </main>
    </div>

    <div id="tagadd-overlay">
        <div class="progress-box">
            <h3 style="color: #059377;margin-bottom: 20px;">Add Tag</h3>
            <form class="tagadd-content" action="{% url 'admin_tag_add' %}" method="post">
                {% csrf_token %}
                <input type="text" id="tagname" placeholder="Tag Name" name="name">
                <input type="submit" class="tagadd-contentbtn" id="tagadd-contentsub">
                <button class="tagadd-contentbtn" id="tagadd-contentclose" type="button">Close</button>
            </form>
        </div>
    </div>

    <div id="tagedit-overlay">
    <div class="progress-box-user">
        <form action="{% url 'admin_user_edit' %}" method="post">
            {% csrf_token %}
            <input type="hidden" name="user_id" value="" id="user_id">
            <ul class="info-list">

                <li>
                    <span class="info-label">First Name</span>
                    {{ form.first_name }}
                    {{ form.first_name.errors }}
                </li>
                <li>
                    <span class="info-label">Last Name</span>
                    {{ form.last_name }}
                    {{ form.last_name.errors }}
                </li>
                <li>
                    <span class="info-label">Email</span>
                    {{ form.email }}
                    {{ form.email.errors }}
                </li>

                <li>
                    <span class="info-label">Staff</span>
                    {{ form.is_staff }}
                </li>
                <li>
                    <span class="info-label">Super User</span>
                    {{ form.is_superuser }}
                </li>

                <li>
                    <span class="info-label">Last Login</span>
                    <span style="line-height: 39px;" id="user_lastlogin">{{ last_login_time }}</span>
                </li>

                <li>
                    <input type="submit" class="tagadd-contentbtn" id="tagadd-contentsub" value="Save Changes">
                    <button class="tagadd-contentbtn" id="tagedit-contentclose" type="button">Close</button>
                </li>
            </ul>

        </form>
    </div>
        
    </div>

    <script>
        $().ready(function () {
            $("#add_tag").click(function () {
                $("#tagadd-overlay").css('display', 'flex');
            })

            $("#tagedit-contentclose").click(function () {
                $("#tagedit-overlay").css('display', 'none');
            })

            $(".admin-btn-edit").click(function () {
                var $item = $(this).closest('.admin-user-list-item');

                // 2. 在父容器内查找对应的数据元素
                // 使用 .find() 结合 data-label 属性或者是类名、位置来定位
                // 注意：这里使用了 .text().trim() 来获取文本并去除可能存在的首尾空格
                var user_id = $item.find('div[data-label="id"]').text().trim();
                var FName = $item.find('span[data-label="fname"]').text().trim();
                var LName = $item.find('span[data-label="lname"]').text().trim();
                var Email = $item.find('div[data-label="email"]').text().trim();
                var LastLogin = $item.find('input[data-label="lastlogin"]').val().trim();
                var Staff = $item.find('div[data-label="staff"] input').val().trim();
                var Superuser = $item.find('div[data-label="superuser"] input').val().trim();

                var isStaff = (Staff === 'True');
                var isSuperuser = (Superuser === 'True');

                $("#tagedit-overlay").css('display', 'flex');
                $("#user_firstname").val(FName);
                $("#user_lastname").val(LName);
                $("#user_email").val(Email);
                $("#user_id").val(user_id);
                $("#user_staff").prop('checked', isStaff);
                $("#user_superuser").prop('checked', isSuperuser);
                $("#user_lastlogin").text(LastLogin);
            })
        })
    </script>
{% endblock %}